# 快跑者开放接口文档 v2

------

- [接口简述](#接口简述)
- [基本约定](#基本约定)
- [接口说明](#接口说明)
- [接口使用流程](#接口使用流程)
- [商户账号认证接口](#商户账号认证接口)
- [获取合作配送团队成员信息接口](#获取合作配送团队成员信息接口)
- [创建配送订单接口](#创建配送订单接口)
- [撤销配送订单接口](#撤销配送订单接口)
- [查看配送订单接口](#查看配送订单接口)
- [订单状态变更后回调](#订单状态变更后回调)
- [附：签名与验签说明](#附签名与验签说明)
    + [请求参数签名](#请求参数签名)
        - [1. 参数筛选](#1-参数筛选)
        - [2. 参数排序](#2-参数排序)
        - [3. 参数拼接](#3-参数拼接)
        - [4. 签名](#4-签名)
    + [返回参数验证签名](#返回参数验证签名)

## 接口简述

简述：本文档系快跑者第三方开放接口文档（v2 版），快跑者开放接口是向其他拥有开发能力的第三方系统开放订单操作能力。第三方系统可通过快跑者开放接口向快跑者系统发送配送订单，并可对订单进行撤销、查看等操作。

版本：v2

更新时间：`2017-05-12`

主要开放接口：

- 商户身份认证接口：`authorization`

- 获取合作团队及成员接口：`getTeamMembers`

- 创建订单接口：`createOrder`

- 撤销订单接口：`cancelOrder`

## 基本约定

在文档描述过程中，为避免因描述模糊而致使开发者理解错误，特对部分关键词做如下约定：

- **第三方系统**：接口的使用方，调用本文档接口的系统或平台（如餐饮外卖平台、物流平台等）

- **快跑者系统**：接口的提供方，向第三方系统开放订单操作能力

- **第三方订单**：第三方系统的订单

- **配送订单**：快跑者系统的订单

注：**第三方订单和配送订单的关系**：开发者在调用创建配送订单接口时，需要将一些第三方订单的参数（如订单内容、订单标识等）当做配送订单的参数（如果第三方订单没有某项参数也可以自定义一个值）。

## 接口说明

快跑者开放接口的返回数据为 **JSON** 格式，主要由以下三个字段组成：

- **code**：状态码，取值有 200，204；200 表示接口调用成功， 204 表示接口调用失败
- **message**：错误信息，当接口调用失败（状态码为 204）时，返回的错误提示信息
- **data**：返回数据，接口调用成功（状态码为 200）之后返回的数据

___

**注：**

+ PHP 开发者可直接获取 [Keloop-PHP-SDK 及 Demo](https://github.com/LingdianIT-Com/keloop/tree/master/v2/Keloop-PHP-SDK)；
+ .NET、JAVA 开发者请参考支付宝接口中的 [加签验签 SDK](https://doc.open.alipay.com/doc2/detail?treeId=54&articleId=103419&docType=1) 组装数据生成 **sign**；
+ 开发者也可参考 [签名与验签说明](#附签名与验签说明) 自由编写处理代码；
+ `access_key` 表示 **商户身份标识** ，`access_sec` 表示 **商户身份密钥**
+ 调用下单接口成功发送配送订单后，系统会返回配送订单单号：`trade_no`，请开发者保存好，用于后续查询和操作订单；
+ 【**重要**：未使用过 v1 版本开放接口的开发者可略过】由于 v1 版本的快跑者开放接口没有和开发者相关联，所以之前生成的商户认证身份（`access_key`）没有绑定开发密钥（`dev_secret`），为兼容之前生成的商户认证身份，特设定在调用获取合作团队及成员接口、创建订单接口和撤销订单接口时可以添加上一个 `dev_secret` 参数，快跑者系统会先判断 `access_key` 是否绑定开发密钥（`dev_secret`），如果没有绑定则获取到 `dev_secret` 参数和 `access_key` 进行绑定，如果没有获取到 `dev_secret` 参数则会直接返回异常！

## 接口使用流程

**先决条件**：请开发者先注册快跑者团队端、商户端及配送端账号，并完整体验从商户端录单到配送员接单的整个流程。

注：快跑者官网：http://www.keloop.cn/

> 快跑者系统主要分为三个终端：团队端、商户端、配送端，各终端的主要职能如下：
**团队端**：关联和管理合作商户、配送员与配送群，分发管理订单；
**商户端**：录单，查看订单；
**配送端**：接单，从配送群中抢单，取单，送单。

1. 在 [开发者中心](http://www.keloop.cn/home/open/index) 注册开发者账号，申请**开发密钥**，得到开发密钥即可进行开发；
2. 调用商户账号认证接口，获取商户身份标识和身份密钥；
3. 根据商户身份标识和身份密钥调用获取合作配送团队及成员接口，获取身份标识所对应的商户合作的配送团队以及配送团队下的配送员和配送群信息；
4. 根据商户身份标识和身份密钥调用创建接口，已身份标识对应的商户的身份创建配送订单；
5. [可选]可调用查看订单接口查看订单的详细信息及状态；
6. [可选]可调用撤销订单接口撤销订单。

## 商户账号认证接口

**简要描述：**获取 **快跑者商户账号** 对应的身份标识（`access_key`）和身份密钥（`access_sec`），调用其他接口时，需要使用身份标识和身份密钥表明身份和进行加密。

**请求 URL：** `http://www.keloop.cn/api/tp2/authorization`

**请求方式：** POST

**请求参数：**

| 参数名 | 必选 | 类型 | 说明 |
|:----:|:---:|:-----:|:-----:|
| `tel` | **是** | `string` | 快跑者商户账号（注册的手机号码），如：`18280091234` |
| `password` | **是** | `string` | 快跑者商户账号密码 |
| `dev_secret` | **是** | `string` | 开发者中心申请的开发密钥 |
| `note` | 否 | `string` | 备注信息，如：`兰州拉面商户`，`宜宾燃面` |

**返回示例**

- 接口调用成功示例
```
{
    "code": 200,
    "message": "",
    "data": {
        "access_key": "JNLHPRC5",
        "access_sec": "6YAK4WCN"
    }
}
```
- 接口调用失败示例
```
{
    "code": 204,
    "message": "快跑者商户密码不正确",
    "data": []
}
```

**返回参数说明：**

| 参数名 | 类型 | 说明 |
|:-----:|:-----:|:-----:|
| `access_key` | `string` | 商户身份标识 |
| `access_sec` | `string` | 商户身份密钥 |

**备注：**

- 开发者调用本接口获取到 `access_key` 和 `access_sec` 之后，请将其妥善保存好。
- 调用其他接口需要使用 `access_key` 参数表明调用者身份，如：以调用创建订单接口（createOrder），则相当于以 `access_key` 对应的商户的身份创建一个订单。
- 如果第三方系统（比如外卖平台系统）下有多个商户，则每个商户需注册一个快跑者商户账号进行关联。

## 获取合作配送团队成员信息接口

**简要描述：**获取商户身份标识（`access_key`）对应的快跑者商户所合作的配送团队及团队下的配送群和配送员信息。

**请求 URL：** `http://www.keloop.cn/api/tp2/getTeamMembers`

**请求方式：** GET

**请求参数：**

| 参数名 | 必选 | 类型 | 说明 |
|:----:|:---:|:-----:|:-----:|
| `access_key` | **是** | `string` | 商户身份标识 |
| `dev_secret` | 否 | `string` | 开发者中心的开发密钥，为兼容 v1 版本开放接口生成的商户身份标识（`access_key`）未绑定开发密钥而做的兼容处理（未使用过 v1 版本开放接口的开发者可略过） |
| `expire_time` | **是** | `int` | 过期时间，时间戳格式，如：1477483702 |
| `sign` | **是** | `string` | 加密密钥，按支付宝密钥排序，可参考**签名与验签说明** |

**返回示例**

- 调用成功示例

```
{
    "code": 200,
    "message": "",
    "data": [
        {
            "info": {
                "team_id": 5,
                "team_name": "跑马帮团队"
            },
            "group": [],
            "courier": [
                {
                    "user_id": 1,
                    "user_name": "德莱厄斯12"
                },
                {
                    "user_id": 20,
                    "user_name": "田丰"
                }
            ]
        },
        {
            "info": {
                "team_id": 3,
                "team_name": "天彻群"
            },
            "group": [
                {
                    "group_id": 4,
                    "group_name": "我我我我我我我我"
                },
                {
                    "group_id": 8,
                    "group_name": "沃文尔"
                }
            ],
            "courier": [
                {
                    "user_id": 1,
                    "user_name": "德莱厄斯12"
                },
                {
                    "user_id": 2,
                    "user_name": "长得帅2号"
                }
            ]
        },
        {
            "info": {
                "team_id": 4,
                "team_name": "test12"
            },
            "group": [
                {
                    "group_id": 5,
                    "group_name": "测试群"
                }
            ],
            "courier": [
                {
                    "user_id": 2,
                    "user_name": "长得帅2号"
                },
                {
                    "user_id": 20,
                    "user_name": "田丰"
                }
            ]
        }
    ]
}
```
- 调用失败示例
```
{
    "code": 204,
    "message": "账号认证异常",
    "data": []
}
```

**返回参数说明：**

| 返回参数名 | 类型 | 说明 |
|:-----:|:-----:|:-----:|
| `info` | `object` | 商户合作的配送团队的信息  |
| `courier` | `array` |  对应配送团队下的配送员的信息  |
| `group` | `array` |  对应配送团队下的配送群的信息  |
| `team_id` | `int` |  商户合作的配送团队 ID  |
| `team_name` | `string` |  商户合作的配送团队名称  |
| `user_id` | `int` |  配送团队下的配送员 ID |
| `user_name` | `string` |  配送团队下的配送员名称  |
| `group_id` | `int` |  配送团队下的配送群 ID  |
| `group_name` | `string` |  配送团队下的配送群名称  |

## 创建配送订单接口

**简要描述：**以商户身份标识（`access_key`）对应的商户的身份向快跑者系统创建订单。

**请求 URL：** `http://www.keloop.cn/api/tp2/createOrder`

**请求方式：** POST

**请求参数：**

| 参数名 | 必选 | 类型 | 默认值 | 说明 |
|:----:|:---:|:-----:|:-----:|:-----:|
| `access_key` | **是** | `string` | 无 | 商户身份标识 |
| `dev_secret` | 否 | `string` | 无 | 开发者中心的开发密钥，为兼容 v1 版本开放接口生成的商户身份标识（`access_key`）未绑定开发密钥而做的兼容处理（未使用过 v1 版本开放接口的开发者可略过） |
| `sign` | **是** | `string` | 无 | 加密密钥，按支付宝密钥排序，可参考**签名与验签说明** |
| `expire_time` | **是** | `int` | 无 | 过期时间，时间戳格式，如：`1477483702` |
| `note` |  否  | `string` | `''` | 自定义参数，快跑者系统调用回调地址时会带上该参数 |
| `order_content` |  否  | `string` | `''` | 第三方订单的订单内容，如：`1份烧白开(100x1)` |
| `order_note` |  否  | `string` | `''` |  第三方订单的备注，如：麻辣一点  |
| `order_mark` |  否  | `string` | `''` |  第三方订单的标识  |
| `order_from` |  否  | `string` | `''` |  第三方订单的来源 |
| `order_send` |  否  | `string` | `''` |  第三方订单的送达时间，如：`下午六点钟之前送达` |
| `order_no` |  是  | `string` | `''` |  第三方订单的单号（必须唯一） |
| `order_time` |  否  | `string` | `''` |  第三方订单的下单时间，如：`2016-12-31 23:59:59` |
| `order_photo` |  否  | `string` | `''` |  第三方订单的图片路径  |
| `order_price` |  否  | `float` | `0.00` |  第三方订单的货物的总价金额，如：`9.99`  |
| `customer_name` |  否  | `string` | `''` |  第三方订单的客户（对应配送订单的收单人）名字 |
| `customer_sex` |  否  | `string` | `''` |  第三方订单的客户性别，如：`男`，`女`，`保密`  |
| `customer_tel` |  否  | `string` | `''` |  第三方订单的客户电话  |
| `customer_address` |  否  | `string` | `''` |  第三方订单的客户地址  |
| `customer_tag` |  否  | `string` | `''` |  第三方订单的客户坐标，如：`104.012765,30.714386`  |
| `pay_status` |  否  | `int` | `0` |  第三方订单的支付方式：0 表示已支付、1 表示货到付款  |
| `pay_type` |  否  | `int` | `3` |  配送订单费用的支付方式，1 表示在线支付，2 表示事后结算，3 表示储备金支付，当团队未设置本商户的储值模式或无法计算配送费时，自动修改为事后结算  |
| `pay_fee` |  否  | `float` | `0.00` |  配送订单的配送费用  |
| `team_id` |  **是**  | `int` | 无 |  配送订单指定的配送团队 ID  |
| `group_id` |  否  | `int` | `0` |  配送订单指定配送团队的配送群ID  |
| `courier_id` |  否  | `int` | `0` |  配送订单指定配送团队的配送员ID  |

**备注：**

- `order_content` 参数如果符合正则规则：`/(.*\([\d\.]+x[\d\.]+\),)+/`，则在订单详情页面会自动以表格的形式展示，如：`五块钱的麻辣烫(5x1),七块钱的麻辣烫(7x1),八块钱的麻辣烫(8x1)`
- `order_no` 参数表示第三方订单的单号，该参数在第三方系统中必须唯一，创建配送订单时，快跑者系统会对其进行查重避免重复发单。
- 如果 `group_id` 和 `courier_id` 都为 0 ，则表示将订单发往团队端（由团队端分发给配送群或配送员），如果 `group_id` 参数不为 0，则表示将订单发往指定配送团队下的配送群，如果 `courier_id` 参数不为 0，则表示将订单发往指定配送团队下的配送员（如果 `group_id` 和 `courier_id` 都不为 0，则优先发往配送群）。

**返回示例**

- 调用成功示例
```
{
    "code": 200,
    "message": "",
    "data": {
        "trade_no": "16120709314700002"
    }
}
```
- 调用失败示例
```
{
    "code": 204,
    "message": "该订单已存在，请勿重复提交",
    "data": []
}
```

**返回参数说明：**

| 返回参数名 | 类型 | 说明 |
|:-----:|:-----:|:-----:|
| `trade_no` | `string` | 配送订单的订单单号，可使用单号查询订单状态及撤销配送订单 |

## 撤销配送订单接口

**简要描述：**开发者撤销快跑者的配送订单（注：只有商户未发单、配送群未抢单、配送员未接单时才可撤销）。

**请求 URL：** `http://www.keloop.cn/api/tp2/cancelOrder`

**请求方式：** POST

**请求参数：**

| 参数名 | 必选 | 类型 | 说明 |
|:----:|:---:|:-----:|:-----:|
| `access_key` | **是** | `string` | 商户身份标识 |
| `dev_secret` | 否 | `string` | 开发者中心的开发密钥，为兼容 v1 版本开放接口生成的商户身份标识（`access_key`）未绑定开发密钥而做的兼容处理（未使用过 v1 版本开放接口的开发者可略过） |
| `sign` | **是** | `string` | 加密密钥，按支付宝密钥排序，可参考**签名与验签说明** |
| `expire_time` | **是** | `int` | 过期时间，时间戳格式，如：1477483702 |
| `trade_no` |  **是**  | `string` |  配送订单的订单单号  |

**返回示例**

- 调用成功示例
```
{
    "code": 200,
    "message": "",
    "data": []
}
```
- 调用失败示例
```
{
    "code": 204,
    "message": "只有待发单、待抢单和待取单的订单才可被撤销",
    "data": [ ]
}
```

**返回参数说明：**

略

## 查看订单接口

**简要描述：**开发者可根据配送订单单号拼接一个固定格式的 url 地址并访问配送订单信息及订单状态。

**说明：**为让快跑者开放接口更为简便易用，现在使用直接跳转 URL 的方式来展示订单详情及相关信息，开发者调用下单接口后，快跑者会返回订单的单号（如：16122813523200001），使用该单号可拼接一个 URL 链接（如：`http://www.keloop.cn/show_order/16122813523200001`），直接访问该链接即可查看该订单的详情和状态。

**备注：** 如果需要直接获取订单信息或状态的接口，请联系快跑者官方。

## 订单状态变更后回调

**简要描述：**开发者调用创建订单接口后会在快跑者系统中创建一个配送订单，配送单被配送员接单（抢单）、送达或被商户或团队撤销时均会向第三方系统回调通知订单改变状态。

**请求 URL：** 本次请求是由快跑者系统向第三方系统发起，请求地址为开发者在快跑者开放中心设置的回调地址

**请求方式：** POST

**请求参数：**

| 参数名 | 类型 | 说明 |
|:----:|:-----:|:-----:|
| `access_key` | `string` | 身份认证标识，第三方系统调用下单接口时使用的身份认证标识 |
| `sign` | `string` | 加密密钥，按支付宝密钥排序，可参考**签名与验签说明**，主要用于验证请求权限 |
| `expire_time` | `int` | 请求的过期时间，时间戳格式，如：1477483702 |
| `note` | `string` | 创建订单时传递自定义参数 |
| `trade_no` | `string` |  状态发生改变的配送订单的订单单号  |
| `state` | `int` |  配送订单状态码，可选值为 4,5,6,7，具体参考下面的订单状态码说明表  |
| `tel` | `string` |  配送员的电话号码  |
| `update_time` | `string` |  配送订单状态的改变时间，如：2017-01-01 01:01:01  |

**订单状态码说明：**

| 状态码 | 说明 | 说明 |
|:----:|:-----:|:-----:|
| `4` | 取单中（已接单/已抢单） | 发往配送群的订单被配送员抢单，或发往配送员的订单被配送员接单 |
| `5` | 送单中（已取单） | 配送员已从取件处领取货物，准备送往收件人 |
| `6` | （已送达） | 配送员已将货物送达到收件人 |
| `7` | （已撤销） | 商户或团队撤销订单 |

**注：**如果开发者未在快跑者开放中心设置回调地址，则不会进行回调。

## 附：签名与验签说明

快跑者开放接口的签名与验签方式借鉴了支付宝接口的签名流程：[支付宝签名流程](https://doc.open.alipay.com/doc2/detail.htm?treeId=200&articleId=105351&docType=1)，因此，PHP、JAVA、C、C++、C# 开放者均可借鉴 [支付宝服务端 SDK](https://doc.open.alipay.com/doc2/detail?treeId=54&articleId=103419&docType=1#s4)。

如果开发者不用 SDK，可根据签名规则自己拼写签名方法，具体的签名流程如下：

### 请求参数签名

#### 1. 参数筛选
获取所有请求参数（不包括字节类型参数，如文件、字节流），剔除参数名为 sign、sign_type、key 的参数及参数值为 '' 或 null 的参数。
以获取配送团队接口为例，需要请求的参数有：

```
{
    "sign": "",
    "expire_time": 1477483702,
    "access_key": "JNLHPRC5"
}
```

经过参数筛选之后参数为：

```
{
    "expire_time": 1477483702,
    "access_key": "JNLHPRC5"
}
```

#### 2. 参数排序
按照参数名第一个字符的键值 ASCII 码递增排序（字母升序排序），如果遇到相同字符则按照第二个字符的键值 ASCII 码递增排序，以此类推。

经过参数排序之后参数为：

```
{
    "access_key": "JNLHPRC5",
    "expire_time": 1477483702
}
```

#### 3. 参数拼接
将排序后的参数与其对应值，组合成“参数=参数值”的格式，并且把这些参数用**&**字符连接起来，此时生成的字符串为待签名字符串，需将待签名字符串和身份认证密钥放入 SHA1 RSA 算法中得出签名（sign）的值。

经过参数拼接之后的字符串为：

```
access_key=JNLHPRC5&expire_time=1477483702
```

#### 4. 签名
使用各自语言对应的 SHA1 With RSA 签名函数（如 PHP 的签名函数是 md5()）利用商户私钥对待签名字符串进行签名。

PHP 的签名方法为：将第三步参数拼接得到的字符串和 access_sec 值拼接起来再进行 MD5 加密，加密后的字符串即为 sign 值。

### 返回参数验证签名

开发者调用下单接口时可以传递一个 notify_url，当快跑者订单的状态发生变化时，会回调该地址，开发者可以对快跑者回调传递的参数进行验证签名，以保证安全。

验证签名，需要将获取到的参数进行签名（参考上面的签名流程），然后再对比 sign 值是否相等，由此进行参数签名验证！
